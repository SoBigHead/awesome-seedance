name: Ingest Approved Case (Issue → main)
on:
  issues:
    types: [labeled]

# Avoid push races when multiple issues are approved at once.
concurrency:
  group: ingest-approved-case
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:
  ingest:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    env:
      PYTHONDONTWRITEBYTECODE: "1"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Sync with main
        run: |
          git fetch origin main
          git checkout main
          git pull --rebase origin main
      - name: Install deps
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pillow
      - name: Ingest issue
        run: |
          python3 scripts/ingest_approved_case.py
      - name: Build site json
        run: |
          python3 scripts/build_site.py
      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "no changes"
            exit 0
          fi
          git commit -m "data: ingest approved case (#${{ github.event.issue.number }})"

          # Rebase on latest main to avoid non-fast-forward push
          git pull --rebase origin main

          git push origin HEAD:main
      - name: Comment back
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner, repo, issue_number,
              body: '✅ Ingested into main. Gallery will update shortly.'
            });
